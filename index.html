<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Bio-Trek</title>
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&amp;display=swap" rel="stylesheet" />
    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background-color: #0a0d36;
        color: #f5f5f5;
      }

      header {
        padding: 1rem 1rem 0.5rem;
        text-align: center;
      }

      main {
        flex: 1;
        display: flex;
        align-items: flex-start;
        justify-content: center;
        padding: 1.5rem 1rem 2.5rem;
      }

      .series-wrapper {
        width: 100%;
        max-width: 1400px;
      }

      .title-main {
        font-family: "Orbitron", sans-serif;
        font-size: 42pt;
        color: #ffd700;
        margin: 0 0 0.25rem;
        letter-spacing: 0.12em;
        text-transform: uppercase;
        text-shadow: 0 0 4px #000000, 0 0 10px rgba(255, 215, 0, 0.8);
      }

      .subtitle-main {
        font-family: "Orbitron", sans-serif;
        font-size: 30pt;
        color: #ffd700;
        margin: 0;
        letter-spacing: 0.1em;
        text-transform: uppercase;
        text-shadow: 0 0 3px #000000, 0 0 8px rgba(255, 215, 0, 0.7);
      }

      .return-link {
        display: none;
        margin: 0.75rem auto 0;
        font-family: "Orbitron", sans-serif;
        font-size: 0.9rem;
        letter-spacing: 0.18em;
        text-transform: uppercase;
        color: #ffffff;
        cursor: pointer;
        opacity: 0.9;
        padding: 0.4rem 1.5rem;
        border-radius: 999px;
        border: 0.5px solid #ffd700;
        transition: opacity 140ms ease-out, text-shadow 140ms ease-out, transform 140ms ease-out;
        width: fit-content;
        text-align: center;
      }

      .return-link:hover {
        opacity: 1;
        text-shadow: 0 0 4px #000000, 0 0 10px rgba(250, 204, 107, 0.9);
        transform: translateY(-1px);
      }

      .series-grid {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-top: 100px;
      }

      .button-row {
        display: flex;
        gap: 2rem;
        justify-content: center;
        width: 100%;
        max-width: 1100px;
      }

      .button-row+.button-row {
        margin-top: 75px;
      }

      .series-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        padding: 1rem 1.5rem;
        border-radius: 999px;
        border: 1px solid #ffffff;
        font-size: 12pt;
        font-weight: 700;
        letter-spacing: 0.03em;
        text-transform: uppercase;
        background-image: linear-gradient(135deg, #011926 0%, #003E5C 100%);
        color: #B29433;
        box-shadow: 0 4px 0 #000000, 0 16px 30px rgba(0, 0, 0, 0.95), inset 0 1px 0 rgba(255, 255, 255, 0.08), inset 0 -3px 10px rgba(0, 0, 0, 0.95);
        cursor: pointer;
        transition: transform 160ms ease-out, box-shadow 160ms ease-out, border-color 160ms ease-out;
        text-align: center;
        white-space: normal;
        line-height: 1.3;
      }

      .series-btn-placeholder {
        visibility: hidden;
        pointer-events: none;
      }

      .series-btn:hover {
        box-shadow: 0 6px 0 #000000, 0 22px 38px rgba(0, 0, 0, 0.98), 0 0 18px rgba(211, 175, 55, 0.6), inset 0 1px 0 rgba(255, 255, 255, 0.12), inset 0 -3px 12px rgba(0, 0, 0, 0.98);
        transform: translateY(-2px) scale(1.02);
        border-color: #f9fafb;
      }

      .series-btn:active {
        box-shadow: 0 2px 0 #000000, 0 10px 18px rgba(0, 0, 0, 0.98), inset 0 1px 0 rgba(255, 255, 255, 0.06), inset 0 -2px 6px rgba(0, 0, 0, 0.98);
        transform: translateY(1px) scale(0.99);
      }

      .cards-grid {
        display: none;
        flex-direction: column;
        align-items: center;
        margin-top: 100px;
      }

      .cards-row {
        display: flex;
        flex-wrap: wrap;
        gap: 1.5rem;
        justify-content: center;
        width: 100%;
        max-width: 1100px;
      }

      .character-card {}

      .character-card.tos-only {
        display: none;
      }

      .character-card {
        flex: 0 1 18%;
        max-width: 260px;
        padding: 1.5rem 1.75rem;
        border-radius: 18px;
        background-image: linear-gradient(135deg, #011926 0%, #003E5C 100%);
        border: 1px solid #ffffff;
        color: #B29433;
        font-size: 12pt;
        font-weight: 700;
        letter-spacing: 0.04em;
        text-transform: uppercase;
        text-align: center;
        box-shadow: 0 4px 0 #000000, 0 16px 30px rgba(0, 0, 0, 0.95), inset 0 1px 0 rgba(255, 255, 255, 0.08), inset 0 -3px 10px rgba(0, 0, 0, 0.95);
        cursor: pointer;
        transition: transform 160ms ease-out, box-shadow 160ms ease-out, border-color 160ms ease-out;
      }

      .character-card:hover {
        box-shadow: 0 6px 0 #000000, 0 22px 38px rgba(0, 0, 0, 0.98), 0 0 18px rgba(211, 175, 55, 0.6), inset 0 1px 0 rgba(255, 255, 255, 0.12), inset 0 -3px 12px rgba(0, 0, 0, 0.98);
        transform: translateY(-2px) scale(1.02);
        border-color: #f9fafb;
      }

      .character-card:active {
        box-shadow: 0 2px 0 #000000, 0 10px 18px rgba(0, 0, 0, 0.98), inset 0 1px 0 rgba(255, 255, 255, 0.06), inset 0 -2px 6px rgba(0, 0, 0, 0.98);
        transform: translateY(1px) scale(0.99);
      }

      .character-card img {
        width: 100%;
        height: auto;
        display: none;
        margin-bottom: 0.75rem;
      }

      .character-card a.character-name {
        color: white !important;
      }

      .character-card p.character-title {
        color: gold !important;
      }

      .character-card a.character-actor {
        color: limegreen !important;
        font-weight: bold !important;
        font-size: 1.1em !important;
        -webkit-text-stroke: 0.5px black !important;
        text-stroke: 0.5px black !important;
      }

      .character-card a.character-name {
        color: white !important;
      }

      .character-card p.character-title {
        color: gold !important;
      }

      .character-card a.character-actor {
        color: limegreen !important;
        -webkit-text-stroke: 0.5px black !important;
        text-stroke: 0.5px black !important;
      }
    </style>
    <style id="gold-headers">
      .bio-header {
        color: gold;
        font-weight: 700;
      }

      h1,
      h2,
      h3,
      h4,
      h5,
      h6 {
        color: gold;
      }
    </style>
    <style>
      /* Ensure TOS images are shown */
      .character-card.tos-only img {
        display: block;
      }
    </style>
    <style>
      /* Unified card image sizing: all images same size */
      .character-card img {
        display: block;
        /* override earlier display:none */
        width: 100%;
        height: 240px;
        /* single consistent height for ALL cards */
        object-fit: cover;
        /* avoid stretching; center-crop to fill area */
      }
    </style>
    <style>
      /* Unified height driven by JS from featured image height */
      :root {
        --card-img-h: auto;
      }

      .character-card img {
        height: var(--card-img-h);
        object-fit: cover;
      }
    </style>
    <style>
      .character-card.tos-only img {
        display: block;
      }
    </style>
    <style>
      /* Text placement only (no typography changes) */
      .character-card img+div {
        margin-top: 0.75rem;
      }

      .character-card .character-name,
      .character-card .character-role,
      .character-card .character-actor {
        display: block;
        margin: 0.2rem 0;
      }

      .character-card a {
        text-decoration: none;
      }
    </style>
    <style>
      /* Layout-only alignment so text starts in the same place as the first three cards */
      .character-card {
        display: flex;
        flex-direction: column;
      }

      .character-card>img {
        display: block;
      }

      /* Use gap to create a consistent space between image and text block */
      .character-card {
        gap: 0.75rem;
      }

      /* Ensure the first text container under image is treated as a block */
      .character-card>.card-text,
      .character-card>#card-1-text,
      .character-card>#card-2-text,
      .character-card>#card-3-text {
        display: block;
      }

      /* No font sizes/weights changed */
    </style>
    <style>
      /* Tighter three-line stack (name/role/actor) without typography changes */
      .character-card .character-name,
      .character-card .character-role,
      .character-card .character-actor {
        display: block;
        margin: 0.1rem 0;
        /* smaller inter-line gap */
        line-height: 1.15;
        /* slightly more than normal */
      }
    </style>
    <style>
      /* Ensure consistent layout so we can compute remaining space for image */
      .character-card {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }

      .character-card>img {
        display: block;
      }
    </style>
    <style>
      /* Ultra-precise line stacking for card text: close to single spacing + ~2px */
      .character-card .character-name,
      .character-card .character-role,
      .character-card .character-actor {
        display: block;
        line-height: calc(1em + 2px) !important;
        /* "text editor + a couple px" */
        margin: 0;
        /* no extra margin between lines */
      }

      /* Remove 
			<br> inserted gaps inside card text containers */
      .character-card>div br {
        display: none;
      }
    </style>
    <style>
      /* Ensure TOS extra card images are visible; text uses default spacing like featured cards */
      .character-card.tos-only img {
        display: block;
      }
    </style>
  </head>
  <body>
    <header>
      <h1 class="title-main">Bio Trek</h1>
      <h2 class="subtitle-main">Star Trek Biographies</h2>
    </header>
    <main>
      <div class="series-wrapper">
        <div class="return-link" id="return-menu"> Return to Series Menu </div>
        <div class="series-grid">
          <div class="button-row">
            <button class="series-btn" data-series="The Original Series" type="button">The Original Series</button>
            <button class="series-btn" data-series="The Next Generation" type="button">The Next Generation</button>
            <button class="series-btn" data-series="Deep Space Nine" type="button">Deep Space Nine</button>
          </div>
          <div class="button-row">
            <button class="series-btn" data-series="Voyager" type="button">Voyager</button>
            <button class="series-btn" data-series="Enterprise" type="button">Enterprise</button>
            <button class="series-btn" data-series="Discovery" type="button">Discovery</button>
          </div>
          <div class="button-row">
            <button class="series-btn" data-series="Picard" type="button">Picard</button>
            <button aria-hidden="true" class="series-btn series-btn-placeholder" tabindex="-1" type="button"></button>
            <button class="series-btn" data-series="Strange New Worlds" type="button">Strange New Worlds</button>
          </div>
        </div>
        <div class="cards-grid">
          <div class="cards-row">
            <div class="character-card" id="card-1">
              <img alt="" id="card-1-img" src="" />
              <div id="card-1-text"></div>
            </div>
            <div class="character-card" id="card-2">
              <img alt="" id="card-2-img" src="" />
              <div id="card-2-text"></div>
            </div>
            <div class="character-card" id="card-3">
              <img alt="" id="card-3-img" src="" />
              <div id="card-3-text"></div>
            </div>
            <div class="character-card tos-only">
              <img alt="Montgomery Scott (TOS)" decoding="async" loading="lazy" src="https://raw.githubusercontent.com/BigBird7827/Bio-Trek/main/Images/Scotty%20(TOS).png" />
              <div class="card-text">
                <a class="character-name" href="#bio-James-T-Kirk">Montgomery Scott</a>
                <p class="character-title">Chief Engineer</p>
                <br />
                <a class="character-actor" href="#">Montgomery Scott</a>
              </div>
            </div>
            <div class="character-card tos-only">
              <img alt="Nyota Uhura (TOS)" decoding="async" loading="lazy" src="https://raw.githubusercontent.com/BigBird7827/Bio-Trek/main/Images/Uhura%20(TOS).png" />
              <div class="card-text">
                <a class="character-name" href="#bio-Spock">Nyota Uhura</a>
                <p class="character-title">Communications Officer</p>
                <br />
                <a class="character-actor" href="#">Nyota Uhura</a>
              </div>
            </div>
            <div class="character-card tos-only">
              <img alt="Hikaru Sulu (TOS)" decoding="async" loading="lazy" src="https://raw.githubusercontent.com/BigBird7827/Bio-Trek/main/Images/Sulu%20(TOS).png" />
              <div class="card-text">
                <a class="character-name" href="#bio-Doctor-McCoy">Hikaru Sulu</a>
                <p class="character-title">Helmsman</p>
                <br />
                <a class="character-actor" href="#">Hikaru Sulu</a>
              </div>
            </div>
            <div class="character-card tos-only">
              <img alt="Pavel Chekov (TOS)" decoding="async" loading="lazy" src="https://raw.githubusercontent.com/BigBird7827/Bio-Trek/main/Images/Chekov%20(TOS).png" />
              <div class="card-text">
                <a class="character-name" href="#bio-Scotty">Pavel Chekov</a>
                <p class="character-title">Navigator</p>
                <br />
                <a class="character-actor" href="#">Pavel Chekov</a>
              </div>
            </div>
            <div class="character-card tos-only">
              <img alt="Yeoman Janice Rand (TOS)" decoding="async" loading="lazy" src="https://raw.githubusercontent.com/BigBird7827/Bio-Trek/main/Images/Yeoman%20Rand%20(TOS).png" />
              <div class="card-text">
                <a class="character-name" href="#bio-Sulu">Yeoman Janice Rand</a>
                <p class="character-title">Yeoman</p>
                <br />
                <a class="character-actor" href="#">Yeoman Janice Rand</a>
              </div>
            </div>
            <div class="character-card tos-only">
              <img alt="Nurse Christine Chapel (TOS)" decoding="async" loading="lazy" src="https://raw.githubusercontent.com/BigBird7827/Bio-Trek/main/Images/Christine%20Chapel%20(TOS).png" />
              <div class="card-text">
                <a class="character-name" href="#bio-Chekov">Nurse Christine Chapel</a>
                <p class="character-title">Nurse</p>
                <br />
                <a class="character-actor" href="#">Nurse Christine Chapel</a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
    <div id="bio-page" style="display:none; text-align:center;">
      <div id="bio-container"></div>
      <button class="nav-button" id="return-series">Return to Series</button>
    </div>
    <div id="build304-status" style="font:14px system-ui, sans-serif; padding:8px 12px;"></div>
    <script>
      (function() {
        const DOC = document;
        const WRAP_SEL = ".series-wrapper";
        const NAME_MAP = {
          "Leonard (Bones) McCoy": "Doctor McCoy",
          "James T. Kirk": "James T Kirk",
          "Montgomery Scott": "Scotty",
          "Nyota Uhura": "Uhura",
          "Hikaru Sulu": "Sulu",
          "Pavel Chekov": "Chekov",
          "Yeoman Janice Rand": "Yeoman Rand",
          "Nurse Christine Chapel": "Nurse Chapel"
        };
        // Exact key maps (unified Bios-TOS.json)
        const CREW_EXACT_KEY = {
          "James T. Kirk": "James T Kirk",
          "Spock": "Spock",
          "Leonard (Bones) McCoy": "Doctor McCoy",
          "Montgomery Scott": "Scotty",
          "Nyota Uhura": "Uhura",
          "Hikaru Sulu": "Sulu",
          "Pavel Chekov": "Chekov",
          "Yeoman Janice Rand": "Yeoman Rand",
          "Nurse Christine Chapel": "Nurse Chapel"
        };
        const ACTOR_EXACT_KEY = {
          "William Shatner": "William Shatner",
          "Leonard Nimoy": "Leonard Nimoy",
          "DeForest Kelley": "DeForest Kelley",
          "James Doohan": "James Doohan",
          "Nichelle Nichols": "Nichelle Nichols",
          "George Takei": "George Takei",
          "Walter Koenig": "Walter Koenig",
          "Grace Lee Whitney": "Grace Lee Whitney",
          "Majel Barrett": "Majel Barrett"
        };
        let snapshotHTML = null;
        let biosCache = null;

        function $(sel, ctx) {
          return (ctx || DOC).querySelector(sel);
        }

        function sanitize(s) {
          return String(s).replace(/[&<>]/g, m => ({
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;'
          } [m]));
        }
        async function loadBios() {
          if (biosCache) return biosCache;
          const res = await fetch("https://raw.githubusercontent.com/BigBird7827/Bio-Trek/main/Biographies/Bios-TOS.json", {
            cache: "no-store"
          });
          const data = await res.json();
          biosCache = data && data.bios ? data.bios : data;
          return biosCache;
        }

        function openSeries(seriesName) {
          const title = $(".title-main");
          const subtitle = $(".subtitle-main");
          const seriesGrid = $(".series-grid");
          const cardsGrid = $(".cards-grid");
          const returnLink = $("#return-menu");
          const wrapper = document.querySelector(".series-wrapper");
          if (wrapper) {
            wrapper.style.background = "";
            wrapper.style.removeProperty("background");
          }
          const card1Text = $("#card-1-text");
          const card2Text = $("#card-2-text");
          const card3Text = $("#card-3-text");
          const card1Img = $("#card-1-img");
          const card2Img = $("#card-2-img");
          const card3Img = $("#card-3-img");
          title.textContent = "Star Trek";
          subtitle.textContent = seriesName;
          seriesGrid.style.display = "none";
          cardsGrid.style.display = "flex";
          window.scrollTo({
            top: 0,
            behavior: "instant"
          });
          returnLink.style.display = "block";
          if (seriesName === "The Original Series") {
            const bioUrl = "https://raw.githubusercontent.com/BigBird7827/Bio-Trek/main/Biographies/Bios-TOS.json";
            card1Text.innerHTML = `
				<a href="${bioUrl}" class="character-name">James T. Kirk</a>
				<br>
					<p class="character-title">Captain</p>
					<br>
						<a href="#" class="character-actor">William Shatner</a>`;
            card2Text.innerHTML = `
						<a href="${bioUrl}" class="character-name">Spock</a>
						<br>
							<p class="character-title">Lt. Commander</p>
							<br>
								<a href="#" class="character-actor">Leonard Nimoy</a>`;
            card3Text.innerHTML = `
								<a href="${bioUrl}" class="character-name">Leonard (Bones) McCoy</a>
								<br>
									<p class="character-title">Doctor</p>
									<br>
										<a href="#" class="character-actor">DeForest Kelley</a>`;
            card1Img.src = "https://raw.githubusercontent.com/BigBird7827/Bio-Trek/main/Images/James%20Kirk%20(TOS).png";
            card2Img.src = "https://raw.githubusercontent.com/BigBird7827/Bio-Trek/main/Images/Spock%20(TOS).png";
            card3Img.src = "https://raw.githubusercontent.com/BigBird7827/Bio-Trek/main/Images/Doctor%20McCoy%20(TOS).png";
            card1Img.style.display = "block";
            card2Img.style.display = "block";
            card3Img.style.display = "block";
            const unifyHeights = () => {
              const h1 = card1Img.getBoundingClientRect().height;
              const h2 = card2Img.getBoundingClientRect().height;
              const h3 = card3Img.getBoundingClientRect().height;
              const h = Math.max(h1, h2, h3) || 0;
              if (h > 0) {
                document.documentElement.style.setProperty("--card-img-h", h + "px");
              }
            };
            [card1Img, card2Img, card3Img].forEach(img => {
              if (img.complete && img.naturalHeight) {
                unifyHeights();
              } else {
                img.addEventListener("load", unifyHeights, {
                  once: true
                });
              }
            });
            DOC.querySelectorAll(".character-card.tos-only").forEach(c => c.style.display = "flex");
          } else {
            DOC.querySelectorAll(".character-card.tos-only").forEach(c => c.style.display = "none");
            card1Text.textContent = "Character 1";
            card2Text.textContent = "Character 2";
            card3Text.textContent = "Character 3";
            card1Img.style.display = "none";
            card2Img.style.display = "none";
            card3Img.style.display = "none";
          }
        }

        function returnToMenu() {
          const title = $(".title-main");
          const subtitle = $(".subtitle-main");
          const seriesGrid = $(".series-grid");
          const cardsGrid = $(".cards-grid");
          const returnLink = $("#return-menu");
          const wrapper = document.querySelector(".series-wrapper");
          if (wrapper) {
            wrapper.style.background = "";
            wrapper.style.removeProperty("background");
          }
          title.textContent = "Bio Trek";
          subtitle.textContent = "Star Trek Biographies";
          cardsGrid.style.display = "none";
          seriesGrid.style.display = "flex";
          returnLink.style.display = "none";
        }

        function renderBio(displayName, sections) {
          const wrapper = $(WRAP_SEL);
          if (!wrapper) return;
          const safeName = sanitize(displayName);
          let html = " < div id = 'bioView'
          style = \"padding:2rem 7.5rem;max-width:1200px;margin:50px auto;\">";
          html += `
											<h1 style="font-family:Orbitron,sans-serif;color:white;text-align:center;font-size:1.5rem;">${safeName}</h1>
											<br>
												<br>`;
          sections.forEach(s => {
            html += `
													<h3 style="color:gold;font-weight:bold;margin-top:1.5rem;max-width:85%;margin-left:auto;margin-right:auto;text-align:left;">${sanitize(s.header)}</h3>`;
            html += `
													<p style="color:white;line-height:1.6;max-width:85%;margin-left:auto;margin-right:auto;">${sanitize(s.text)}</p>`;
          });
          html += `
													<div style="text-align:center;margin-top:2rem;">
														<button id="returnToCrew" style="padding:0.6rem 1.5rem;border:1px solid gold;border-radius:20px;background:transparent;color:gold;cursor:pointer;">Return to Crew</button>
													</div>`;
          html += " < /div>";
          wrapper.style.background = "linear-gradient(135deg, #000010, #001a33)";
          wrapper.innerHTML = html;
          window.scrollTo({
            top: 0,
            behavior: "instant"
          });
        }
        // Normalize any raw sections value to [{header,text}] for renderBio
        function normalizeSections(sections) {
          if (Array.isArray(sections)) return sections;
          if (sections && typeof sections === 'object' && Array.isArray(sections.sections)) return sections.sections;
          if (typeof sections === 'string') return [{
            header: 'Biography',
            text: sections
          }];
          if (sections && typeof sections === 'object') {
            const h = sections.header || sections.title || 'Biography';
            const t = sections.text || sections.body || sections.html || '';
            return [{
              header: String(h),
              text: String(t)
            }];
          }
          return [{
            header: 'Biography',
            text: 'No biography available.'
          }];
        }
        DOC.addEventListener("click", async (ev) => {
          const seriesBtn = ev.target.closest(".series-btn");
          if (seriesBtn) {
            ev.preventDefault();
            openSeries(seriesBtn.getAttribute("data-series"));
            return;
          }
          if (ev.target.closest("#return-menu")) {
            ev.preventDefault();
            returnToMenu();
            return;
          }
          const tosImg = ev.target.closest(".character-card.tos-only img");
          if (tosImg) {
            const card = ev.target.closest(".character-card.tos-only");
            const link = card && card.querySelector("a.character-name");
            if (link) {
              link.click();
            }
            return;
          }
          // Crew link (TOS)
          const charLink = ev.target.closest("a.character-name");
          if (charLink && ($('.subtitle-main')?.textContent === 'The Original Series')) {
            ev.preventDefault();
            const wrapper = $(WRAP_SEL);
            if (!wrapper) return;
            if (!snapshotHTML) snapshotHTML = wrapper.innerHTML;
            const displayName = charLink.textContent.trim();
            const key = NAME_MAP[displayName] || displayName;
            wrapper.innerHTML = " < p style = 'text-align:center;font-family:Orbitron,sans-serif;font-size:1.5rem;color:gold;' > Loading biography... < /p>";
            try {
              const bios = await loadBios();
              const exactKey = (CREW_EXACT_KEY && CREW_EXACT_KEY[displayName]) || (NAME_MAP && NAME_MAP[displayName]) || displayName;
              let sections = null;
              if (bios && bios.Crew) sections = bios.Crew[exactKey];
              if (!sections && bios && bios.bios) sections = bios.bios[exactKey];
              if (!sections) sections = bios[exactKey] || bios[exactKey?.replace(/\./g, '')] || bios[exactKey?.replace(/[^A-Za-z ]/g, '')];
              if (!sections && bios && bios.characters) sections = bios.characters[exactKey] || bios.characters[displayName];
              if (!sections && bios && bios.crew) sections = bios.crew[exactKey] || bios.crew[displayName];
              renderBio(displayName, normalizeSections(sections));
            } catch (e) {
              wrapper.innerHTML = " < p style = 'text-align:center;color:tomato;' > Error loading biography data. < /p>";
            }
            return;
          }
          // Actor link (TOS)
          const actorLink = ev.target.closest("a.character-actor");
          if (actorLink && ($('.subtitle-main')?.textContent === 'The Original Series')) {
            ev.preventDefault();
            const wrapper = $(WRAP_SEL);
            if (!wrapper) return;
            if (!snapshotHTML) snapshotHTML = wrapper.innerHTML;
            const displayName = actorLink.textContent.trim();
            const key = NAME_MAP[displayName] || displayName;
            wrapper.innerHTML = " < p style = 'text-align:center;font-family:Orbitron,sans-serif;font-size:1.5rem;color:gold;' > Loading actor biography... < /p>";
            try {
              const bios = await loadBios();
              const exactKey = (ACTOR_EXACT_KEY && ACTOR_EXACT_KEY[displayName]) || displayName;
              let sections = null;
              if (bios && bios.Actors) sections = bios.Actors[exactKey];
              if (!sections && bios && bios.actors) sections = bios.actors[exactKey];
              if (!sections && bios && bios.actorBios) sections = bios.actorBios[exactKey];
              if (!sections) sections = bios[exactKey];
              renderBio(displayName, normalizeSections(sections));
            } catch (e) {
              wrapper.innerHTML = " < p style = 'text-align:center;color:tomato;' > Error loading actor biography. < /p>";
            }
            return;
          }
          if (ev.target && ev.target.id === "returnToCrew") {
            ev.preventDefault();
            const wrapper = $(WRAP_SEL);
            if (!wrapper || !snapshotHTML) return;
            wrapper.style.background = "";
            wrapper.style.removeProperty("background");
            wrapper.innerHTML = snapshotHTML;
            snapshotHTML = null;
            const seriesGrid = $(".series-grid", wrapper);
            const cardsGrid = $(".cards-grid", wrapper);
            if (seriesGrid && cardsGrid) {
              seriesGrid.style.display = "none";
              cardsGrid.style.display = "flex";
              window.scrollTo({
                top: 0,
                behavior: "instant"
              });
            }
            return;
          }
        });
      })();
    </script>
    <script>
      (function() {
        const img1 = document.querySelector("#card-1-img");
        if (!img1) return;

        function syncHeight() {
          const h = img1.getBoundingClientRect().height;
          if (h > 0) document.documentElement.style.setProperty("--card-img-h", h + "px");
        }
        if (img1.complete && img1.naturalHeight) {
          syncHeight();
        } else {
          img1.addEventListener("load", syncHeight, {
            once: true
          });
        }
        window.addEventListener("resize", syncHeight);
      })();
    </script>
    <!-- BEGIN: Modular series layer (Build 428) -->
    <style>
      .series-non-tos .character-card.tos-only {
        display: none !important;
      }
    </style>
    <script type="module">
      const $ = (s, r = document) => r.querySelector(s);
      const $$ = (s, r = document) => r.querySelectorAll(s);
      const SERIES = {
        "TNG": [{
          id: 'picard',
          name: 'Jean-Luc Picard',
          role: 'Captain',
          actor: 'Patrick Stewart',
          img: 'https://raw.githubusercontent.com/BigBird7827/Bio-Trek/main/Images/Jean-Luc%20Picard%20(TNG).png'
        }, {
          id: 'riker',
          name: 'William T. Riker',
          role: 'First Officer',
          actor: 'Jonathan Frakes',
          img: 'https://raw.githubusercontent.com/BigBird7827/Bio-Trek/main/Images/William%20T%20Riker%20(TNG).png'
        }, {
          id: 'data',
          name: 'Data',
          role: 'Operations',
          actor: 'Brent Spiner',
          img: 'https://raw.githubusercontent.com/BigBird7827/Bio-Trek/main/Images/Data%20(TNG).png'
        }, {
          id: 'barclay',
          name: 'Reginald Barclay',
          role: 'Engineer',
          actor: 'Dwight Schultz',
          img: 'https://raw.githubusercontent.com/BigBird7827/Bio-Trek/main/Images/Barclay%20(TNG).png'
        }, {
          id: 'crusher',
          name: 'Beverly Crusher',
          role: 'Chief Medical Officer',
          actor: 'Gates McFadden',
          img: 'https://raw.githubusercontent.com/BigBird7827/Bio-Trek/main/Images/Beverly%20Crusher%20(TNG).png'
        }, {
          id: 'obrien',
          name: "Chief O'Brien",
          role: 'Transporter Chief',
          actor: 'Colm Meaney',
          img: "https://raw.githubusercontent.com/BigBird7827/Bio-Trek/main/Images/Chief%20O'Brien%20(TNG).png"
        }, {
          id: 'guinan',
          name: 'Guinan',
          role: 'Ten Forward Host',
          actor: 'Whoopi Goldberg',
          img: 'https://raw.githubusercontent.com/BigBird7827/Bio-Trek/main/Images/Guinan%20(TNG).png'
        }, {
          id: 'yar',
          name: 'Tasha Yar',
          role: 'Security Chief',
          actor: 'Denise Crosby',
          img: 'https://raw.githubusercontent.com/BigBird7827/Bio-Trek/main/Images/Tasha%20Yar%20(TNG).png'
        }, {
          id: 'troi',
          name: 'Deanna Troi',
          role: 'Counselor',
          actor: 'Marina Sirtis',
          img: 'https://raw.githubusercontent.com/BigBird7827/Bio-Trek/main/Images/Troi%20(TNG).png'
        }, {
          id: 'worf',
          name: 'Worf',
          role: 'Tactical/Security',
          actor: 'Michael Dorn',
          img: 'https://raw.githubusercontent.com/BigBird7827/Bio-Trek/main/Images/Worf%20(TNG).png'
        }],
        "VOY": [{
          id: 'janeway',
          name: 'Kathryn Janeway',
          role: 'Captain',
          img: 'https://raw.githubusercontent.com/BigBird7827/Bio-Trek/main/Images/Kathry%20Janeway%20(Voy).png'
        }, {
          id: 'chakotay',
          name: 'Chakotay',
          role: 'First Officer',
          img: 'https://raw.githubusercontent.com/BigBird7827/Bio-Trek/main/Images/Chakotay%20(Voy).png'
        }, {
          id: 'tuvok',
          name: 'Tuvok',
          role: 'Security/Tactical',
          img: 'https://raw.githubusercontent.com/BigBird7827/Bio-Trek/main/Images/Tuvok%20(Voy).png'
        }, {
          id: 'paris',
          name: 'Tom Paris',
          role: 'Helmsman',
          img: 'https://raw.githubusercontent.com/BigBird7827/Bio-Trek/main/Images/Tom%20Paris%20(VOY).png'
        }, {
          id: 'torres',
          name: "B'Elanna Torres",
          role: 'Chief Engineer',
          img: "https://raw.githubusercontent.com/BigBird7827/Bio-Trek/main/Images/B'Elanna%20Torres%20(VOY).png"
        }, {
          id: 'kim',
          name: 'Harry Kim',
          role: 'Operations',
          img: 'https://raw.githubusercontent.com/BigBird7827/Bio-Trek/main/Images/Harry%20Kim%20(VOY).png'
        }, {
          id: 'seven',
          name: 'Seven of Nine',
          role: 'Astrometrics',
          img: 'https://raw.githubusercontent.com/BigBird7827/Bio-Trek/main/Images/Seven%20of%20Nine%20(VOY).png'
        }, {
          id: 'doctor',
          name: 'The Doctor',
          role: 'Chief Medical Officer',
          img: 'https://raw.githubusercontent.com/BigBird7827/Bio-Trek/main/Images/The%20Doctor%20(VOY).png'
        }, {
          id: 'neelix',
          name: 'Neelix',
          role: 'Morale Officer',
          img: 'https://raw.githubusercontent.com/BigBird7827/Bio-Trek/main/Images/Neelix%20(VOY).png'
        }],
        "DS9": [{
          id: 'sisko',
          name: 'Benjamin Sisko',
          role: 'Commander/Captain',
          img: 'https://raw.githubusercontent.com/BigBird7827/Bio-Trek/main/Images/Benjamin%20Sisko%20(DS9).png'
        }, {
          id: 'kira',
          name: 'Kira Nerys',
          role: 'First Officer',
          img: 'https://raw.githubusercontent.com/BigBird7827/Bio-Trek/main/Images/Major%20Kira%20(DS9).png'
        }, {
          id: 'worf',
          name: 'Worf',
          role: 'Strategic Ops',
          img: 'https://raw.githubusercontent.com/BigBird7827/Bio-Trek/main/Images/Worf%20(DS9).png'
        }, {
          id: 'jadzia',
          name: 'Jadzia Dax',
          role: 'Science Officer',
          img: 'https://raw.githubusercontent.com/BigBird7827/Bio-Trek/main/Images/Jadzia%20Dax%20(DS9).png'
        }, {
          id: 'bashir',
          name: 'Dr. Julian Bashir',
          role: 'Chief Medical Officer',
          img: 'https://raw.githubusercontent.com/BigBird7827/Bio-Trek/main/Images/Doctor%20Bashir%20(DS9).png'
        }, {
          id: 'obrien',
          name: "Chief O'Brien",
          role: 'Chief of Operations',
          img: "https://raw.githubusercontent.com/BigBird7827/Bio-Trek/main/Images/Chief%20O'Brien%20(DS9).png"
        }, {
          id: 'odo',
          name: 'Odo',
          role: 'Security Chief',
          img: 'https://raw.githubusercontent.com/BigBird7827/Bio-Trek/main/Images/Odo%20(DS9).png'
        }, {
          id: 'quark',
          name: 'Quark',
          role: 'Bartender',
          img: 'https://raw.githubusercontent.com/BigBird7827/Bio-Trek/main/Images/Quark%20(DS9).png'
        }]
      };

      function topThreeSlots() {
        return [{
          img: '#card-1-img',
          text: '#card-1-text'
        }, {
          img: '#card-2-img',
          text: '#card-2-text'
        }, {
          img: '#card-3-img',
          text: '#card-3-text'
        }, ];
      }

      function setTopThree(people) {
        const slots = topThreeSlots();
        for (let i = 0; i < 3; i++) {
          const p = people[i] || null;
          const imgEl = document.querySelector(slots[i].img);
          const txtEl = document.querySelector(slots[i].text);
          if (imgEl) {
            if (p?.img) {
              imgEl.src = p.img;
              imgEl.style.removeProperty('display');
            } else {
              imgEl.removeAttribute('src');
            }
          }
          if (txtEl) {
            txtEl.innerHTML = p ? `
        
												<a href="#" class="character-name">${p.name}</a>
												<p class="character-title">${p.role || ''}</p>
												<br>
													<a href="#" class="character-actor">${p.actor || ''}</a>` : '';
          }
        }
      }

      function dynamicHost() {
        const tosCard = document.querySelector('.character-card.tos-only');
        return tosCard?.parentElement || document.querySelector('#crew-grid') || document.querySelector('main') || document.body;
      }

      function clearDynamic() {
        document.querySelectorAll('.series-dynamic').forEach(el => el.remove());
      }

      function renderExtras(people, seriesKey) {
        const host = dynamicHost();
        people.slice(3).forEach(p => {
          const card = document.createElement('article');
          card.className = `character-card series-dynamic ${seriesKey.toLowerCase()}-only`;
          const a = document.createElement('a');
          a.href = '#';
          a.className = 'character-link';
          const img = document.createElement('img');
          img.className = 'character-image';
          img.alt = p.name;
          if (p.img) img.src = p.img;
          const text = document.createElement('div');
          text.className = 'character-text';
          text.innerHTML = `
      
													<a href="#" class="character-name">${p.name}</a>
													<p class="character-title">${p.role || ''}</p>
													<br>
														<a href="#" class="character-actor">${p.actor || ''}</a>`;
          a.appendChild(img);
          a.appendChild(text);
          card.appendChild(a);
          host.appendChild(card);
        });
      }

      function applySeries(seriesKey) {
        if (seriesKey === 'TOS') {
          document.documentElement.classList.remove('series-non-tos');
          clearDynamic();
          return;
        }
        document.documentElement.classList.add('series-non-tos');
        clearDynamic();
        const people = SERIES[seriesKey] || [];
        setTopThree(people);
        renderExtras(people, seriesKey);
      }
      document.addEventListener('click', (e) => {
        const btn = e.target.closest && e.target.closest('.series-btn');
        if (!btn) return;
        const label = (btn.getAttribute('data-series') || btn.textContent || '').toLowerCase();
        if (label.includes('tng') || label.includes('next generation')) {
          applySeries('TNG');
        } else if (label.includes('voy') || label.includes('voyager')) {
          applySeries('VOY');
        } else if (label.includes('ds9') || label.includes('deep space nine')) {
          applySeries('DS9');
        } else if (label.includes('tos') || label.includes('original')) {
          applySeries('TOS');
        }
      });
      document.addEventListener('DOMContentLoaded', () => {
        const subtitle = (document.querySelector('.subtitle-main')?.textContent || '').toLowerCase();
        if (subtitle.includes('tng') || subtitle.includes('next generation')) applySeries('TNG');
        else if (subtitle.includes('voy') || subtitle.includes('voyager')) applySeries('VOY');
        else if (subtitle.includes('ds9') || subtitle.includes('deep space nine')) applySeries('DS9');
      });
    </script>
    <!-- END: Modular series layer (Build 428) -->
  </body>
</html>
